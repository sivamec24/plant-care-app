{% extends "base.html" %}
{% from "components/breadcrumb.html" import breadcrumb %}

{% block title %}{{ guide.name }} Care Guide - How to Grow & Water | PlantCareAI{% endblock %}

{% block description %}{{ guide.meta_description }}{% endblock %}

{% block og_title %}{{ guide.name }} Care Guide | PlantCareAI{% endblock %}
{% block og_description %}{{ guide.meta_description }}{% endblock %}

{% block og_image %}
<meta property="og:image" content="{{ url_for('static', filename='images/og/guide-' ~ guide.slug ~ '.png', _external=True) }}" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content="{{ guide.name }} Care Guide - PlantCareAI" />
{% endblock %}
{% block twitter_title %}{{ guide.name }} Care Guide{% endblock %}
{% block twitter_description %}{{ guide.meta_description }}{% endblock %}
{% block twitter_image %}
<meta name="twitter:image" content="{{ url_for('static', filename='images/og/guide-' ~ guide.slug ~ '.png', _external=True) }}" />
<meta name="twitter:image:alt" content="{{ guide.name }} Care Guide - PlantCareAI" />
{% endblock %}

{% block extra_head %}
<!-- Article Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": {{ (guide.name ~ " Care Guide") | tojson }},
  "description": {{ guide.meta_description | tojson }},
  "author": {
    "@type": "Organization",
    "name": "PlantCareAI"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PlantCareAI"
  },
  "image": "{{ url_for('static', filename='images/og/guide-' ~ guide.slug ~ '.png', _external=True) }}",
  "datePublished": "{{ guide.last_updated }}T00:00:00+00:00",
  "dateModified": "{{ guide.last_updated }}T00:00:00+00:00"
}
</script>
<!-- HowTo Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": {{ ("How to Care for " ~ guide.name) | tojson }},
  "description": {{ guide.summary | tojson }},
  "totalTime": {{ guide.howto.totalTime | tojson }},
  "supply": [
    {% for supply in guide.howto.supplies %}
    { "@type": "HowToSupply", "name": {{ supply | tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  "tool": [
    {% for tool in guide.howto.tools %}
    { "@type": "HowToTool", "name": {{ tool | tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  "step": [
    {
      "@type": "HowToStep",
      "position": 1,
      "name": "Watering",
      "text": {{ guide.watering | tojson }}
    },
    {
      "@type": "HowToStep",
      "position": 2,
      "name": "Light Requirements",
      "text": {{ guide.light_details | tojson }}
    },
    {
      "@type": "HowToStep",
      "position": 3,
      "name": "Humidity & Temperature",
      "text": {{ guide.humidity | tojson }}
    },
    {
      "@type": "HowToStep",
      "position": 4,
      "name": "Fertilizing",
      "text": {{ guide.fertilizing | tojson }}
    }{% if guide.propagation %},
    {
      "@type": "HowToStep",
      "position": 5,
      "name": "Propagation",
      "text": {{ guide.propagation.intro | tojson }}
    }{% endif %}
  ]
}
</script>
{% endblock %}

{% block content %}
{{ breadcrumb([
  {"label": "Plant Care Guides", "url": url_for('guides.index')},
  {"label": guide.name},
]) }}

<!-- Header -->
<header class="mb-8">
  <div class="flex items-start gap-4 mb-4">
    <div class="text-6xl" aria-hidden="true">{{ guide.emoji }}</div>
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100">
        {{ guide.name }} Care Guide
      </h1>
      <p class="text-lg text-slate-500 dark:text-slate-400 italic">{{ guide.scientific_name }}</p>
    </div>
  </div>
  <p class="text-xl text-slate-600 dark:text-slate-400 max-w-3xl">
    {{ guide.summary }}
  </p>
</header>

<!-- Quick Stats -->
<section class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="card text-center">
    <div class="text-3xl mb-2" aria-hidden="true">‚òÄÔ∏è</div>
    <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Light</div>
    <div class="font-semibold text-slate-900 dark:text-slate-100">{{ guide.light }}</div>
  </div>
  <div class="card text-center">
    <div class="text-3xl mb-2" aria-hidden="true">üíß</div>
    <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Water</div>
    <div class="font-semibold text-slate-900 dark:text-slate-100">{{ guide.water }}</div>
  </div>
  <div class="card text-center">
    <div class="text-3xl mb-2" aria-hidden="true">üí®</div>
    <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Humidity</div>
    <div class="font-semibold text-slate-900 dark:text-slate-100">{{ guide.humidity_level }}</div>
  </div>
  <div class="card text-center">
    <div class="text-3xl mb-2" aria-hidden="true">üå°Ô∏è</div>
    <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Difficulty</div>
    <div class="font-semibold text-slate-900 dark:text-slate-100">{{ guide.difficulty }}</div>
  </div>
</section>

<!-- Quick Care Reference Table -->
{% if guide.care_table %}
<section class="mb-8">
  <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4">Quick Care Reference</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm text-left border-collapse">
      <thead>
        <tr class="border-b-2 border-slate-200 dark:border-slate-700">
          <th scope="col" class="py-3 pr-4 font-semibold text-slate-900 dark:text-slate-100">Care Aspect</th>
          <th scope="col" class="py-3 pr-4 font-semibold text-slate-900 dark:text-slate-100">Requirement</th>
          <th scope="col" class="py-3 font-semibold text-slate-900 dark:text-slate-100">Frequency</th>
        </tr>
      </thead>
      <tbody>
        {% for row in guide.care_table %}
        <tr class="border-b border-slate-100 dark:border-slate-800">
          <td class="py-3 pr-4 font-medium text-slate-900 dark:text-slate-100">{{ row.aspect }}</td>
          <td class="py-3 pr-4 text-slate-600 dark:text-slate-400">{{ row.requirement }}</td>
          <td class="py-3 text-slate-600 dark:text-slate-400">{{ row.frequency }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<!-- Care Details -->
<div class="grid lg:grid-cols-3 gap-8">
  <div class="lg:col-span-2 space-y-8">
    <!-- Watering -->
    <section id="watering" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üíß</span> Watering
      </h2>
      <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
        {{ guide.watering }}
      </p>
    </section>

    <!-- Light -->
    <section id="light" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">‚òÄÔ∏è</span> Light Requirements
      </h2>
      <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
        {{ guide.light_details }}
      </p>
    </section>

    <!-- Humidity & Temperature -->
    <section id="humidity" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üå°Ô∏è</span> Humidity & Temperature
      </h2>
      <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
        {{ guide.humidity }}
      </p>
    </section>

    <!-- Fertilizing -->
    <section id="fertilizing" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üß™</span> Fertilizing
      </h2>
      <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
        {{ guide.fertilizing }}
      </p>
    </section>

    <!-- Propagation -->
    {% if guide.propagation %}
    <section id="propagation" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">‚úÇÔ∏è</span> Propagation
      </h2>
      <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
        {{ guide.propagation.intro }}
      </p>
      {% for method in guide.propagation.methods %}
      <div class="{% if not loop.first %}mt-6{% endif %}">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">{{ method.name }}</h3>
        <ol class="list-decimal list-inside space-y-1 text-slate-600 dark:text-slate-400">
          {% for step in method.steps %}
          <li>{{ step }}</li>
          {% endfor %}
        </ol>
      </div>
      {% endfor %}
      <div class="flex flex-wrap gap-3 mt-4">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400">
          Best time: {{ guide.propagation.best_time }}
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300">
          Difficulty: {{ guide.propagation.difficulty }}
        </span>
      </div>
    </section>
    {% endif %}

    <!-- Varieties & Cultivars -->
    {% if guide.varieties %}
    <section id="varieties" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üå±</span> Popular Varieties
      </h2>
      <div class="grid sm:grid-cols-2 gap-4">
        {% for variety in guide.varieties %}
        <div class="rounded-lg border border-slate-200 dark:border-slate-700 p-4">
          <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">{{ variety.name }}</h3>
          {% if variety.also_known_as %}
          <p class="text-xs text-slate-500 dark:text-slate-400 mb-2 italic">Also known as: {{ variety.also_known_as }}</p>
          {% endif %}
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">{{ variety.description }}</p>
          <div class="flex flex-wrap gap-2">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">
              {{ variety.light_needs }}
            </span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
              {{ variety.difficulty }}
            </span>
          </div>
          {% if variety.special_note %}
          <p class="text-xs text-emerald-600 dark:text-emerald-400 mt-2">{{ variety.special_note }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Seasonal Care Calendar -->
    {% if guide.care_calendar %}
    <section id="care-calendar" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üìÖ</span> Seasonal Care Calendar
      </h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for season in guide.care_calendar %}
        <div class="rounded-lg border border-slate-200 dark:border-slate-700 p-4">
          <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">{{ season.season }}</h3>
          <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">{{ season.months }}</p>
          <ul class="space-y-1 text-sm text-slate-600 dark:text-slate-400">
            {% for task in season.tasks %}
            <li class="flex items-start gap-1.5">
              <span class="text-emerald-500 mt-0.5" aria-hidden="true">‚Ä¢</span>
              <span>{{ task }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Troubleshooting (replaces Common Problems when present) -->
    {% if guide.troubleshooting %}
    <section id="troubleshooting" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">üîç</span> Troubleshooting
      </h2>
      <div class="space-y-6">
        {% for item in guide.troubleshooting %}
        <div class="{% if not loop.first %}border-t border-slate-200 dark:border-slate-700 pt-6{% endif %}">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">{{ item.symptom }}</h3>
          <p class="text-slate-600 dark:text-slate-400 mb-2">
            <span class="font-medium text-slate-700 dark:text-slate-300">Why it happens:</span> {{ item.causes }}
          </p>
          <p class="text-slate-600 dark:text-slate-400">
            <span class="font-medium text-slate-700 dark:text-slate-300">What to do:</span> {{ item.fix }}
          </p>
          {% if item.landing_page_slug %}
          <a href="/{{ item.landing_page_slug }}" class="inline-flex items-center gap-1 text-sm text-emerald-600 dark:text-emerald-400 hover:underline mt-2">
            Learn more: {{ item.landing_page_title }} ‚Üí
          </a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% elif guide.common_problems %}
    <!-- Fallback: Common Problems (for guides not yet expanded) -->
    <section id="common-problems" class="card scroll-mt-20">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2">
        <span aria-hidden="true">‚ö†Ô∏è</span> Common Problems
      </h2>
      <ul class="space-y-3">
        {% for problem in guide.common_problems %}
        <li class="flex items-start gap-3">
          <span class="text-amber-500 mt-1" aria-hidden="true">‚Ä¢</span>
          <span class="text-slate-600 dark:text-slate-400">{{ problem }}</span>
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </div>

  <!-- Sidebar -->
  <aside class="space-y-6">
    <!-- Table of Contents -->
    <nav class="card" aria-label="Table of contents">
      <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-3">
        On This Page
      </h3>
      <ul class="space-y-2 text-sm">
        <li><a href="#watering" class="text-emerald-600 dark:text-emerald-400 hover:underline">Watering</a></li>
        <li><a href="#light" class="text-emerald-600 dark:text-emerald-400 hover:underline">Light Requirements</a></li>
        <li><a href="#humidity" class="text-emerald-600 dark:text-emerald-400 hover:underline">Humidity & Temperature</a></li>
        <li><a href="#fertilizing" class="text-emerald-600 dark:text-emerald-400 hover:underline">Fertilizing</a></li>
        {% if guide.propagation %}
        <li><a href="#propagation" class="text-emerald-600 dark:text-emerald-400 hover:underline">Propagation</a></li>
        {% endif %}
        {% if guide.varieties %}
        <li><a href="#varieties" class="text-emerald-600 dark:text-emerald-400 hover:underline">Popular Varieties</a></li>
        {% endif %}
        {% if guide.care_calendar %}
        <li><a href="#care-calendar" class="text-emerald-600 dark:text-emerald-400 hover:underline">Seasonal Care</a></li>
        {% endif %}
        {% if guide.troubleshooting %}
        <li><a href="#troubleshooting" class="text-emerald-600 dark:text-emerald-400 hover:underline">Troubleshooting</a></li>
        {% elif guide.common_problems %}
        <li><a href="#common-problems" class="text-emerald-600 dark:text-emerald-400 hover:underline">Common Problems</a></li>
        {% endif %}
      </ul>
    </nav>

    <!-- Ask AI CTA -->
    <div class="card bg-gradient-to-br from-emerald-50 to-cyan-50 dark:from-emerald-900/20 dark:to-cyan-900/20 border-2 border-emerald-200 dark:border-emerald-700">
      <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-2">
        Have a specific question?
      </h3>
      <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
        Our AI plant doctor can give you personalized advice based on your location and situation.
      </p>
      <a href="{{ url_for('web.assistant') }}?plant={{ guide.name | urlencode }}"
         class="btn btn-primary w-full text-center">
        Ask about {{ guide.name }}
      </a>
    </div>

    <!-- Quick Tips -->
    <div class="card">
      <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
        Quick Tips
      </h3>
      <ul class="space-y-3 text-sm">
        {% for tip in guide.quick_tips %}
        <li class="flex items-start gap-2">
          <span class="text-emerald-500" aria-hidden="true">‚úì</span>
          <span class="text-slate-600 dark:text-slate-400">{{ tip }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Related Articles -->
    {% if guide.troubleshooting %}
    {% set related = guide.troubleshooting | selectattr('landing_page_slug') | list %}
    {% if related %}
    <div class="card">
      <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-3">
        Related Articles
      </h3>
      <ul class="space-y-2 text-sm">
        {% for item in related %}
        <li>
          <a href="/{{ item.landing_page_slug }}" class="text-emerald-600 dark:text-emerald-400 hover:underline">
            {{ item.landing_page_title }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% endif %}

    <!-- Related Guides -->
    <div class="card">
      <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
        More Guides
      </h3>
      <a href="{{ url_for('guides.index') }}" class="text-emerald-600 dark:text-emerald-400 hover:underline text-sm">
        View all plant care guides ‚Üí
      </a>
    </div>
  </aside>
</div>

<!-- Bottom CTA -->
<section class="mt-12 py-8 text-center bg-white dark:bg-slate-800 -mx-4 px-4 rounded-2xl">
  <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-4">
    Track your {{ guide.name }} with PlantCareAI
  </h2>
  <p class="text-slate-600 dark:text-slate-400 mb-6 max-w-xl mx-auto">
    Get weather-aware watering reminders and personalized care tips. Free for up to 20 plants.
  </p>
  <a href="{{ url_for('auth.signup') }}" class="btn btn-primary">
    Create Free Account
  </a>
</section>
{% endblock %}
